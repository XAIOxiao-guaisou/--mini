# ğŸ” æŒä¹…åŒ–ç™»å½•ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## âœ¨ æ ¸å¿ƒæ”¹è¿›

æœ¬æ¬¡å‡çº§å®ç°äº†**ä¼ä¸šçº§æŒä¹…åŒ–ç™»å½•ç³»ç»Ÿ**ï¼Œå½»åº•è§£å†³é¢‘ç¹ç™»å½•å’ŒéªŒè¯ç é—®é¢˜ï¼š

### 1. æŠ€æœ¯æ¶æ„å‡çº§

#### **ä½¿ç”¨ `launch_persistent_context` æ›¿ä»£ `launch()`**
- âœ… **æ‰€æœ‰Cookieã€LocalStorageã€Sessionè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°**
- âœ… **åªéœ€äººå·¥ç™»å½•ä¸€æ¬¡ï¼Œåç»­æ°¸ä¹…å¤ç”¨**
- âœ… **å…±äº«ç™»å½•çŠ¶æ€**ï¼šå°çº¢ä¹¦å’Œé—²é±¼ä½¿ç”¨åŒä¸€ä¸ªæµè§ˆå™¨é…ç½®

#### **ä¿®å¤Stealthæ³¨å…¥é”™è¯¯**
- âœ… **æ­£ç¡®å¯¼å…¥**ï¼šä» `from playwright_stealth import Stealth` æ”¹ä¸º `from playwright_stealth import stealth_async`
- âœ… **æ­£ç¡®ä½¿ç”¨**ï¼š`await stealth_async(page)` è€Œä¸æ˜¯å®ä¾‹åŒ–Stealthç±»
- âœ… **é”™è¯¯æ•è·**ï¼šStealthå¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨å¤‡é€‰åæ£€æµ‹æ–¹æ¡ˆ

#### **äººç±»è¡Œä¸ºæ¨¡æ‹Ÿ**
- âœ… **éçº¿æ€§å»¶è¿Ÿ**ï¼š`random.uniform(2.0, 5.0) + jitter`
- âœ… **è´å¡å°”æ›²çº¿é¼ æ ‡ç§»åŠ¨**ï¼šæ¨¡æ‹ŸçœŸå®è½¨è¿¹
- âœ… **åˆ†æ®µæ»šåŠ¨**ï¼šéåŒ€é€Ÿæ»šåŠ¨è¡Œä¸º
- âœ… **éšæœºUser-Agentå’ŒViewport**ï¼šæ¯æ¬¡å¯åŠ¨ä½¿ç”¨ä¸åŒæŒ‡çº¹

---

## ğŸ“‹ ä½¿ç”¨æµç¨‹

### **ç¬¬ä¸€æ­¥ï¼šé¦–æ¬¡ç™»å½•ï¼ˆä»…éœ€ä¸€æ¬¡ï¼‰**

è¿è¡Œç™»å½•è¾…åŠ©è„šæœ¬ï¼š

```bash
python login_helper.py
```

**æ“ä½œæ­¥éª¤ï¼š**

1. è„šæœ¬ä¼šå¯åŠ¨Chromeæµè§ˆå™¨ï¼ˆå¯è§çª—å£ï¼‰
2. é€‰æ‹©å¹³å°ï¼š
   - `1` - å°çº¢ä¹¦
   - `2` - é—²é±¼
   - `3` - ä¸¤ä¸ªéƒ½ç™»å½•ï¼ˆæ¨èï¼‰
3. åœ¨æµè§ˆå™¨çª—å£ä¸­æ‰‹åŠ¨å®Œæˆç™»å½•ï¼š
   - ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - æ‰«ç /çŸ­ä¿¡éªŒè¯
   - å®ŒæˆäººæœºéªŒè¯ï¼ˆæ»‘å—/æ—‹è½¬ï¼‰
4. ç¡®è®¤çœ‹åˆ°å¤´åƒå’Œç”¨æˆ·å
5. å›åˆ°ç»ˆç«¯ï¼ŒæŒ‰ **Enter** é”®
6. è„šæœ¬éªŒè¯ç™»å½•æˆåŠŸåï¼ŒSessionè‡ªåŠ¨ä¿å­˜

**ç™»å½•æ•°æ®å­˜å‚¨ä½ç½®ï¼š**
```
./browser_profile/
â”œâ”€â”€ Default/
â”‚   â”œâ”€â”€ Cookies          â† Cookieæ–‡ä»¶
â”‚   â”œâ”€â”€ Local Storage/   â† LocalStorageæ•°æ®
â”‚   â””â”€â”€ Session Storage/ â† Sessionæ•°æ®
```

---

### **ç¬¬äºŒæ­¥ï¼šè¿è¡Œçˆ¬è™«ï¼ˆè‡ªåŠ¨å¤ç”¨ç™»å½•ï¼‰**

æ­£å¸¸è¿è¡Œä¸»ç¨‹åºï¼š

```bash
python main.py
```

**è‡ªåŠ¨åŒ–æµç¨‹ï¼š**

1. âœ… çˆ¬è™«å¯åŠ¨æ—¶**è‡ªåŠ¨åŠ è½½**æŒä¹…åŒ–Session
2. âœ… **æ— éœ€é‡æ–°ç™»å½•**ï¼Œç›´æ¥ä½¿ç”¨å·²ä¿å­˜çš„Cookie
3. âœ… ç¨‹åºè‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
4. âœ… å¦‚æœæ£€æµ‹åˆ°æœªç™»å½•ï¼Œæç¤ºè¿è¡Œ `login_helper.py`

---

## ğŸ” ç™»å½•çŠ¶æ€æ£€æŸ¥

çˆ¬è™«å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œç™»å½•æ£€æŸ¥ï¼š

```python
# åœ¨çˆ¬è™«å†…éƒ¨è‡ªåŠ¨è°ƒç”¨
is_logged_in = await spider.check_login_status()
if not is_logged_in:
    print("âŒ æœªç™»å½•ï¼Œè¯·å…ˆè¿è¡Œ python login_helper.py")
    return
```

**æ£€æµ‹åŸç†ï¼š**
- è®¿é—®é¦–é¡µï¼ŒæŸ¥æ‰¾ç™»å½•åç‰¹æœ‰å…ƒç´ ï¼ˆå¤´åƒã€ç”¨æˆ·åç­‰ï¼‰
- ä½¿ç”¨å¤šä¸ªé€‰æ‹©å™¨é™çº§ç­–ç•¥ï¼Œæé«˜æ£€æµ‹å‡†ç¡®æ€§

---

## ğŸ› ï¸ ç™»å½•ç»´æŠ¤

### **ä½•æ—¶éœ€è¦é‡æ–°ç™»å½•ï¼Ÿ**

- âœ… **æ­£å¸¸æƒ…å†µ**ï¼šç™»å½•å¯æŒç»­æ•°å‘¨ç”šè‡³æ•°æœˆ
- âš ï¸ **éœ€è¦é‡æ–°ç™»å½•çš„æƒ…å†µ**ï¼š
  - Cookieè¿‡æœŸï¼ˆé€šå¸¸30å¤©ï¼‰
  - å¹³å°å¼ºåˆ¶é€€å‡ºç™»å½•
  - æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸ºè¢«å°å·
  - æ›´æ¢ç½‘ç»œç¯å¢ƒï¼ˆIPå˜åŒ–ï¼‰

### **é‡æ–°ç™»å½•æ–¹æ³•ï¼š**

1. **åˆ é™¤æ—§çš„æµè§ˆå™¨é…ç½®**ï¼š
   ```bash
   rm -rf ./browser_profile  # Linux/Mac
   rmdir /s browser_profile  # Windows
   ```

2. **é‡æ–°è¿è¡Œç™»å½•è„šæœ¬**ï¼š
   ```bash
   python login_helper.py
   ```

---

## ğŸ§ äººç±»è¡Œä¸ºæ¨¡æ‹Ÿ

ç³»ç»Ÿå·²è‡ªåŠ¨é›†æˆä»¥ä¸‹äººç±»è¡Œä¸ºç‰¹å¾ï¼š

### **1. éçº¿æ€§å»¶è¿Ÿ**
```python
await spider.human_delay(min_sec=2.0, max_sec=5.0)
```
- éšæœºå»¶è¿Ÿ + å¾®æŠ–åŠ¨
- é¿å…å›ºå®šæ—¶é—´é—´éš”è¢«æ£€æµ‹

### **2. é¼ æ ‡è½¨è¿¹æ¨¡æ‹Ÿ**
```python
await spider.human_mouse_move(target_x=500, target_y=300)
```
- è´å¡å°”æ›²çº¿å¼ç§»åŠ¨
- 15-30ä¸ªæ­¥éª¤ï¼Œæ¯æ­¥å¸¦éšæœºåç§»

### **3. æ»šåŠ¨è¡Œä¸ºæ¨¡æ‹Ÿ**
```python
await spider.human_scroll(distance=500)
```
- åˆ†æ®µæ»šåŠ¨ï¼ŒéåŒ€é€Ÿ
- æ¨¡æ‹Ÿäººç±»æµè§ˆèŠ‚å¥

---

## ğŸ› å¸¸è§é—®é¢˜

### **Q1: Stealthæ³¨å…¥å¤±è´¥ï¼Ÿ**

**é”™è¯¯ä¿¡æ¯ï¼š**
```
TypeError: 'module' object is not callable
```

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²ä¿®å¤ï¼šä½¿ç”¨ `stealth_async(page)` è€Œä¸æ˜¯ `Stealth()`
- âœ… è‡ªåŠ¨é™çº§ï¼šStealthå¤±è´¥æ—¶ä½¿ç”¨å¤‡é€‰åæ£€æµ‹è„šæœ¬

---

### **Q2: Target page has been closedï¼Ÿ**

**åŸå› ï¼š**
- æµè§ˆå™¨å› è¶…æ—¶æˆ–ç½‘ç«™æ£€æµ‹è¢«å¼ºåˆ¶å…³é—­

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… ä½¿ç”¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡åï¼Œæ­¤é—®é¢˜å¤§å¹…å‡å°‘
- âœ… å¢åŠ äº†å¼‚å¸¸æ•è·å’Œè‡ªåŠ¨é‡å¯æœºåˆ¶

---

### **Q3: ç™»å½•çŠ¶æ€æ£€æµ‹å¤±è´¥ï¼Ÿ**

**å¯èƒ½åŸå› ï¼š**
- é¡µé¢å…ƒç´ å˜åŒ–ï¼ˆé€‰æ‹©å™¨å¤±æ•ˆï¼‰
- ç½‘ç»œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ‰‹åŠ¨æµ‹è¯•ç™»å½•çŠ¶æ€
python -c "
import asyncio
from scrapers.spider import XhsSpider

async def test():
    spider = XhsSpider(headless=False)
    await spider.init_browser()
    result = await spider.check_login_status()
    print('ç™»å½•çŠ¶æ€:', result)
    await spider.close()

asyncio.run(test())
"
```

---

### **Q4: Chromeæµè§ˆå™¨æœªæ‰¾åˆ°ï¼Ÿ**

**é”™è¯¯ä¿¡æ¯ï¼š**
```
âŒ Chromeæµè§ˆå™¨æœªæ‰¾åˆ°ï¼
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **å®‰è£…Google Chrome**ï¼š
   - ä¸‹è½½åœ°å€ï¼šhttps://www.google.com/chrome/

2. **æˆ–ä¿®æ”¹ `config.py` æŒ‡å®šè·¯å¾„**ï¼š
   ```python
   CHROME_PATH = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
   ```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### **æŒä¹…åŒ–ä¸Šä¸‹æ–‡å‚æ•°**

```python
self.context = await playwright.chromium.launch_persistent_context(
    user_data_dir=USER_DATA_PATH,     # æ•°æ®å­˜å‚¨ç›®å½•
    executable_path=chrome_path,      # Chromeå¯æ‰§è¡Œæ–‡ä»¶
    headless=False,                   # å¯è§æ¨¡å¼ï¼ˆé¦–æ¬¡ç™»å½•å¿…é¡»ï¼‰
    args=[
        '--disable-blink-features=AutomationControlled',  # éšè—è‡ªåŠ¨åŒ–
        '--no-sandbox',                                   # ç¦ç”¨æ²™ç®±
    ],
    viewport={'width': 1920, 'height': 1080},  # éšæœºè§†å£
    user_agent='Mozilla/5.0 ...',              # éšæœºUA
    locale='zh-CN',
    timezone_id='Asia/Shanghai',
)
```

### **åæ£€æµ‹è„šæœ¬**

```javascript
// ä¿®æ”¹navigator.webdriver
Object.defineProperty(navigator, 'webdriver', {
    get: () => false,
});

// ä¼ªè£…Chrome Runtime
window.chrome = {
    runtime: {},
    loadTimes: function() {},
    csi: function() {},
    app: {},
};

// ä¿®æ”¹plugins
Object.defineProperty(navigator, 'plugins', {
    get: () => [1, 2, 3, 4, 5],
});
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### **èµ„æºæ‹¦æˆª**
```python
# ç¦ç”¨å›¾ç‰‡ã€å­—ä½“ã€æ ·å¼è¡¨
if request.resource_type in ['image', 'stylesheet', 'media', 'font']:
    await route.abort()
```

### **è¯·æ±‚å¤´ä¼˜åŒ–**
```python
# ç§»é™¤è‡ªåŠ¨åŒ–ç‰¹å¾å¤´
for key in ['Sec-Fetch-Dest', 'Sec-Fetch-Mode', 'Sec-Fetch-Site']:
    headers.pop(key, None)

# æ·»åŠ çœŸå®æµè§ˆå™¨å¤´
headers.update({
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
    'Accept-Encoding': 'gzip, deflate, br',
})
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¦–æ¬¡ç™»å½•å»ºè®®å¯è§æ¨¡å¼**ï¼š
   ```bash
   # login_helper.py é»˜è®¤å°±æ˜¯å¯è§æ¨¡å¼
   python login_helper.py
   ```

2. **ç”Ÿäº§ç¯å¢ƒå¯ä½¿ç”¨æ— å¤´æ¨¡å¼**ï¼š
   ```python
   spider = XhsSpider(headless=True)  # ç™»å½•åå¯ä»¥æ— å¤´è¿è¡Œ
   ```

3. **å®šæœŸç»´æŠ¤ç™»å½•çŠ¶æ€**ï¼š
   - å»ºè®®æ¯å‘¨è¿è¡Œä¸€æ¬¡ `login_helper.py`
   - è®¿é—®ä¸ªäººä¸­å¿ƒä¿æŒæ´»è·ƒ

4. **ç›‘æ§ç™»å½•çŠ¶æ€**ï¼š
   ```python
   # åœ¨çˆ¬è™«ä¸»å¾ªç¯ä¸­å®šæœŸæ£€æŸ¥
   if not await spider.check_login_status():
       logger.error("ç™»å½•å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•")
       return
   ```

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

- [ ] è‡ªåŠ¨æ£€æµ‹Cookieè¿‡æœŸå¹¶æé†’
- [ ] æ”¯æŒå¤šè´¦å·åˆ‡æ¢
- [ ] é›†æˆéªŒè¯ç è‡ªåŠ¨è¯†åˆ«ï¼ˆOCRï¼‰
- [ ] åŠ¨æ€ä»£ç†æ± è½®æ¢
- [ ] åˆ†å¸ƒå¼çˆ¬è™«æ¶æ„

---

## ğŸ“ æ›´æ–°æ—¥å¿—

**2025-12-31 é‡å¤§å‡çº§ï¼š**
- âœ… å®ç°æŒä¹…åŒ–ç™»å½•ï¼ˆlaunch_persistent_contextï¼‰
- âœ… ä¿®å¤Stealthæ³¨å…¥é”™è¯¯ï¼ˆstealth_asyncï¼‰
- âœ… æ–°å¢ç™»å½•è¾…åŠ©è„šæœ¬ï¼ˆlogin_helper.pyï¼‰
- âœ… æ–°å¢ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ˆcheck_login_statusï¼‰
- âœ… æ–°å¢äººç±»è¡Œä¸ºæ¨¡æ‹Ÿï¼ˆhuman_delay, human_mouse_move, human_scrollï¼‰
- âœ… ç»Ÿä¸€ä½¿ç”¨Chromeæµè§ˆå™¨ï¼ˆé™ä½æ£€æµ‹é£é™©ï¼‰
- âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼ŸæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```bash
cat niche_finder.log  # Linux/Mac
type niche_finder.log # Windows
```

å…³é”®æ—¥å¿—æ ‡è¯†ï¼š
- âœ… `æŒä¹…åŒ–ä¸Šä¸‹æ–‡` - ç¡®è®¤ä½¿ç”¨æŒä¹…åŒ–æ¨¡å¼
- âœ… `Stealthåæ£€æµ‹è¡¥ä¸` - ç¡®è®¤åæ£€æµ‹æ¿€æ´»
- âœ… `æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€` - ç¡®è®¤ç™»å½•æˆåŠŸ
- âŒ `æœªæ£€æµ‹åˆ°ç™»å½•` - éœ€è¦è¿è¡Œlogin_helper.py
